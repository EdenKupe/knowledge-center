function windowKit(a){this.callBacks=["onConnect","onReady","onMessageEvent","onSkillChange","onAgentTextEvent","onAgentRichContentEvent","onAgentChatState","onMessageSent","onVisitorTextEvent","onVisitorMessage"];this.readStates={read:"READ",accept:"ACCEPT"};this.chatStates={composing:"COMPOSING",pause:"PAUSE"};this.callBackStack=[];this.initStack=[];this.openConvs={};this.lastSequence=0;this.defaults={apiRequestTypes:["cqm.SubscribeExConversations","ms.PublishEvent","GetClock","getUserProfile","cm.ConsumerRequestConversation","ms.SubscribeMessagingEvents","InitConnection","cm.UpdateConversationField","cm.RequestConversationResponse"],debug:false};this.options=Object.assign(this.defaults,a);var b=this;this.console=function(d,e,c){c=c||"info";if(!b.options.debug){return}e=e?JSON.parse(JSON.stringify(e)):null;console[c](d,e)};this.error=function(c,d){b.console(c,d,"error")};this.warn=function(c,d){b.console(c,d,"warn")};this.socket={requests:{},subscriptions:[],ws:null,connect:function(c){return new Promise(function(f,e){var d=new WebSocket(c);b.socket.ws=d;d.onopen=function(){return f(b.socket)};d.onmessage=function(g){return b.socket.onmessage(g)};d.onclose=function(g){b.socket.ws=null;e(g)}})},onmessage:function(d){var c=JSON.parse(d.data);if(c.kind==="resp"){var e=c.reqId;delete c.reqId;delete c.kind;b.socket.requests[e].call(b.socket,c.type,c.code,c.body);delete b.socket.requests[e]}else{if(c.kind==="notification"){b.socket.subscriptions.forEach(function(f){if(f.filter.call(b.socket,c)){f.cb.call(b.socket,c.body)}})}}},registerRequests:function(){b.options.apiRequestTypes.forEach(function(c){b.socket[b.socket.toFuncName(c)]=function(d,e){return b.socket.request(c,d,e)};return b.socket[b.socket.toFuncName(c)]})},toFuncName:function(c){var d=c.substr(1+c.lastIndexOf("."));return d.charAt(0).toLowerCase()+d.slice(1)},request:function(d,c,e){return new Promise(function(g,f){var h={kind:"req",type:d,body:c||{},id:Math.floor(Math.random()*1000000000).toString(),headers:e};if(d=="GetClock"){h={kind:"req",type:d,id:1}}b.socket.requests[h.id]=function(k,l,j){return g({type:k,code:l,body:j})};var i=JSON.stringify(h);b.socket.ws.send(i)})},onNotification:function(d,c){b.socket.subscriptions.push({filter:d,cb:c})},onNotificationType:function(c){return function(d){return d.type.includes(c)}},subscriptionID:function(c){return function(d){return d.body.subscriptionId===c}}};this.lpUtils={getDomain:function(c){var d=b.options.account.toString().startsWith("le")?"hc1n.dev.lprnd.net":"adminlogin.liveperson.net";return new Promise(function(e,g){return b.jsonp({jsonp:"cb",jsonpCallback:"domainCallback",url:"https://"+d+"/csdr/account/"+b.options.account+"/service/"+c+"/baseURI.lpCsds?version=1.0",success:function h(i){return e(i.ResultSet.lpData[0].lpServer)},error:function f(i,j){return g(j)}})})},signup:function(){return new Promise(function(c,d){return b.lpUtils.getDomain("idp").then(function(e){return b.jsonp({url:"https://"+e+"/api/account/"+b.options.account+"/signup.jsonp",success:function f(g){return c(g.jwt)}})})})},getJWT:function(){var c=localStorage.getItem(b.options.account+"-jwt");if(c){return Promise.resolve(c)}else{if(window.preFillJWT!==undefined){localStorage.setItem(b.options.account+"-jwt",window.preFillJWT);return Promise.resolve(window.preFillJWT)}else{return b.lpUtils.signup().then(function(d){localStorage.setItem(b.options.account+"-jwt",d);return Promise.resolve(d)})}}},authJWT:function(){return new Promise(function(d,c){return b.lpUtils.getJWT(b.options.account).then(function(e){return b.lpUtils.getDomain(b.options.account,"idp").then(function(f){return $.ajax({url:"https://"+f+"/api/account/"+b.options.account+"/authenticate",type:"POST",data:JSON.stringify({authCode:e}),dataType:"json",contentType:"application/json; charset=utf-8",success:function g(h){return d(h.jwt)}})})})})}};this.ajax=function(c){var d=new XMLHttpRequest();d.onreadystatechange=function(){if(this.readyState==4&&this.status==200){if(c.success){c.success(this.response)}}else{if(c.error){c.error(this.status,this.response)}}};d.open(c.type||"GET",c.url,true);d.send()};this.jsonp=function(e){var f=e.jsonpCallback||"jsonp_callback_"+Math.round(100000*Math.random());var d=e.url;window[f]=function(g){delete window[f];document.head.removeChild(c);e.success(g)};var c=document.createElement("script");c.src=d+(d.indexOf("?")>=0?"&":"?")+(e.jsonp||"callback")+"="+f;document.head.appendChild(c)};this.connect=function(){var c=b.options.authenticated?"authJWT":"getJWT";b.lpUtils[c](b.options.account).then(function(d){b.lpUtils.getDomain("asyncMessagingEnt").then(function(e){b.socket.connect("wss://"+e+"/ws_api/account/"+b.options.account+"/messaging/consumer?v=3").then(function(f){b.executeCallback("onConnect",b);b.initWith({type:".ams.headers.ConsumerAuthentication",jwt:d});b.console("Connected to "+b.options.account);b.setParticipantId(d);return b.socketOpened(f,d)},function(f){b.executeCallback("onFailedConnection",b,f);b.error("Failed to initiate connection.",f);throw f})})},function(d){throw d})};this.initWith=function(c){this.initStack.push(c||{})};this.socketOpened=function(c){c.registerRequests(b.options.apiRequestTypes);var d=b.options.skillId?{skillId:b.options.skillId}:{};c.initConnection({},this.initStack);setInterval(function(){c.getClock()},10000);c.onNotification(c.onNotificationType("MessagingEvent"),function(e){e.changes.forEach(function(f){var g=f.originatorId==b.participantId?"sent":"received";b.executeCallback("onMessageEvent",f,g);b.lastSequence=f.sequence;switch(g){case"received":switch(f.event.type){case"ContentEvent":b.console("onAgentTextEvent",f);b.executeCallback("onAgentTextEvent",f.event.message,f);break;case"RichContentEvent":b.console("onAgentRichContentEvent",f);b.executeCallback("onAgentRichContentEvent",f.event.content,f);break;case"ChatStateEvent":b.console("onAgentChatState",f);b.executeCallback("onAgentChatState",f.event.chatState,f);break;case"AcceptStatusEvent":b.console("onAgentAcceptStatus",f);b.executeCallback("onAgentAcceptStatus",f.event.status,f);break;default:b.console("onAgentMessage",f);b.executeCallback("onAgentMessage",f.event,g,f);break}break;case"text":switch(f.event.type){case"ContentEvent":b.console("onVisitorTextEvent",f);b.executeCallback("onVisitorTextEvent",f.event.message,f);break;default:b.console("onVisitorMessage",f);b.executeCallback("onVisitorMessage",f.event,f);break}break}})});c.subscribeExConversations({convState:["OPEN"]}).then(function(e){var f;c.onNotification(b.socket.subscriptionID(e.body.subscriptionId),function(g){return b.conversationNotification(c,g)});setTimeout(function(){if(Object.keys(b.openConvs)[0]){f=Object.keys(b.openConvs)[0];b.setInteractions(f);b.console("Existing conversation",f)}else{c.consumerRequestConversation(d).then(function(g){f=g.body.conversationId;b.setInteractions(f);b.console("New conversation",f)})}},1000)})};this.setInteractions=function(c){b.console("Connection Ready.",c);b.executeCallback("onReady",c);b.sendMessage=function(d){d=d.trim();b.socket.publishEvent({dialogId:c,event:{type:"ContentEvent",contentType:"text/plain",message:d}}).then(function(e){b.executeCallback("onMessageSent",d,e)})};b.sendReadState=function(e,d){d=d||[];b.socket.publishEvent({dialogId:c,event:{type:"AcceptStatusEvent",status:e,sequenceList:d}})};b.sendChatState=function(d){b.socket.publishEvent({dialogId:c,event:{type:"ChatStateEvent",chatState:d}})}};this.conversationNotification=function(c,d){d.changes.forEach(function(e){if(e.type==="UPSERT"){if(!b.openConvs[e.result.convId]){b.openConvs[e.result.convId]=e.result;c.subscribeMessagingEvents({fromSeq:0,dialogId:e.result.convId})}if(e.result.conversationDetails.skillId!=b.options.skillId){b.options.skillId=e.result.conversationDetails.skillId;b.executeCallback("onSkillChange",e.result.conversationDetails.skillId)}}else{if(e.type==="DELETE"){delete b.openConvs[e.result.convId]}}})};this.setParticipantId=function(c){b.participantId=JSON.parse(atob(c.split(".")[1])).sub;return b.participantId};this.executeCallback=function(d){var c=arguments;if(!b.callBackStack[d]){return}b.callBackStack[d].forEach(function(e){(e)(c[1]||null,c[2]||null,c[3]||null)})};(function(c){c.callBacks.forEach(function(d){c[d]=function(e){c.callBackStack[d]=c.callBackStack[d]||[];c.callBackStack[d].push(e)}})})(this)};